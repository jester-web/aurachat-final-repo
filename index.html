
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AuraChat - Giri≈ü ve Kayƒ±t</title>
    <style>
        /* CSS aynƒ± kalƒ±yor, g√∂rsel temaya uygun */
        :root {
            --bg-dark: #1F2128; 
            --bg-medium: #272A32;
            --bg-light: #2E313A; 
            --color-text: #E5E7EB; 
            --color-link: #8B5CF6; 
            --color-success: #34D399; 
            --color-danger: #F87171; 
            --border-color: #3B3F49;
        }

        body { display: flex; margin: 0; height: 100vh; font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--color-text); }
        #login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; background-color: var(--bg-dark); position: absolute; z-index: 100; }
        .login-box { background-color: var(--bg-medium); padding: 40px 50px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); text-align: center; border: 1px solid var(--border-color); }
        #login-screen h2 { margin-bottom: 25px; color: white; font-size: 1.8em; }
        #login-screen input, #login-screen button { padding: 14px; margin: 10px 0; width: 320px; border-radius: 8px; border: none; background-color: var(--bg-dark); color: var(--color-text); border: 1px solid var(--border-color); }
        #login-screen button { background-color: var(--color-link); cursor: pointer; font-weight: bold; transition: background-color 0.2s, box-shadow 0.3s; box-shadow: 0 0 10px rgba(139, 90, 246, 0.5); }
        #login-error { color: var(--color-danger); margin-top: 10px; }
        #toggle-auth-btn { background-color: transparent; color: var(--color-link); text-decoration: underline; font-size: 0.9em; margin-top: 15px; }

        /* UYGULAMA EKRANI */
        #app-screen { display: none; width: 100%; height: 100%; flex-direction: row; }
        #channels { width: 220px; padding: 15px 0; background-color: var(--bg-medium); border-right: 1px solid var(--border-color); overflow-y: auto; }
        #channels h4 { padding: 0 15px; margin-top: 15px; margin-bottom: 10px; color: #A0AEC0; font-size: 0.85em; text-transform: uppercase; }
        .channel-item { padding: 8px 15px; margin: 2px 8px; cursor: pointer; border-radius: 6px; font-weight: 500;}
        .active-channel { background-color: var(--color-link); color: white; }
        
        /* KANAL ALTINDAKƒ∞ √úYE KARTLARI */
        .voice-user-list { margin-bottom: 10px; }
        .voice-user-container { display: flex; align-items: center; padding: 4px 15px 4px 15px; margin-left: 10px; margin-right: 10px; margin-bottom: 4px; border-radius: 4px; background-color: var(--bg-dark); border: 1px solid var(--border-color); }
        .voice-user-container.speaking-user { border-color: var(--color-success); box-shadow: 0 0 3px rgba(52, 211, 153, 0.8); }
        .voice-user-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; margin-right: 8px; border: 1px solid var(--border-color); }
        .voice-user-name { flex-grow: 1; font-size: 0.9em; }

        /* CHAT */
        #chat-main { flex-grow: 1; display: flex; flex-direction: column; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: var(--bg-light); }
        .user-msg { margin-bottom: 15px; line-height: 1.5; border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding-bottom: 10px; }
        .nickname { font-weight: bold; color: white; margin-right: 10px; }

        /* INPUT */
        #input-area { padding: 15px 20px; display: flex; gap: 15px; background-color: var(--bg-light); border-top: 1px solid var(--border-color); }
        .status-btn { padding: 10px 15px; cursor: pointer; background-color: var(--bg-medium); color: var(--color-text); border: none; border-radius: 6px; }
        #leave-btn { background-color: var(--color-danger); color: white; display: none; }

        /* PROFIL */
        #profile-bar {
            position: fixed; bottom: 0; left: 0; width: 220px; 
            background-color: var(--bg-dark); padding: 8px 10px; 
            border-top: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
        }
        #my-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 8px; cursor: pointer; }
    </style>
</head>
<body>
    
    <div id="login-screen">
        <div class="login-box">
            <h2 id="auth-title">Giri≈ü Yap</h2>
            
    
     <input type="text" id="server-url-input" placeholder="Sunucu Adresi" value="https://aurachat-oyir.onrender.com" style="display:none;">       <input type="email" id="email-input" placeholder="E-posta">
            <input type="password" id="password-input" placeholder="≈ûifre">
            
            <button id="auth-main-btn" onclick="authenticate()">Giri≈ü Yap</button>
            <p id="login-error"></p>

            <button id="toggle-auth-btn" onclick="toggleAuthMode()">Hesabƒ±n yok mu? Kayƒ±t Ol</button>
        </div>
    </div>

    <div id="app-screen">
        
        <div id="channels">
            <h4>METƒ∞N KANALLARI</h4>
            <div class="channel-item active-channel" data-type="chat" data-id="ana-sohbet-kanali"># genel-sohbet</div>

            <h4>SES KANALLARI</h4>
            <div class="voice-channel-group">
                <div class="channel-item" data-type="voice" data-id="ana-ses-odasi">üîä Ana Ses Odasƒ±</div>
                <div class="voice-user-list" data-channel-id="ana-ses-odasi"></div>
            </div>
        </div>

        <div id="chat-main">
            <div id="messages">
                <p class="system-msg">Uygulama y√ºkleniyor...</p>
            </div>
            
            <div id="input-area">
                <button id="voice-btn" class="status-btn" onclick="joinChannel('ana-ses-odasi', 'voice')" disabled>üîä Kanala Katƒ±l</button> 
                <button id="leave-btn" class="status-btn" onclick="leaveCurrentVoiceChannel()">‚ùå Baƒülantƒ±yƒ± Kes</button>
                <button id="mute-btn" class="status-btn" onclick="toggleMute()" disabled>üé§ Mute</button>
                <button id="deafen-btn" class="status-btn" onclick="toggleDeafen()" disabled>üéß Deafen</button>
                
                <input type="text" id="message-input" placeholder="Mesaj g√∂nder (Enter)..." disabled>
            </div>
        </div>
        
        <div id="users-online">
            <h4>√áEVRƒ∞Mƒ∞√áƒ∞ KULLANICILAR</h4>
            <ul id="user-list"></ul>
        </div>
    </div>

    <div id="profile-bar">
        <img id="my-avatar" src="" alt="Avatar">
        <span id="my-nickname">Kullanƒ±cƒ± Y√ºkleniyor...</span>
        <span id="settings-btn" onclick="openSettings()">‚öôÔ∏è</span>
    </div>

    <div id="settings-modal">
        <div class="settings-content">
            <h3>Profil Ayarlarƒ±</h3>
            <span style="color:var(--color-danger);" id="profile-error-message"></span>

            <label style="display:block; margin-top:15px; color:#A0AEC0;">Kullanƒ±cƒ± Adƒ±</label>
            <input type="text" id="setting-nickname" placeholder="Yeni Kullanƒ±cƒ± Adƒ±">

            <label style="display:block; margin-top:10px; color:#A0AEC0;">Avatar URL (Rastgele bƒ±rakmak i√ßin bo≈ü bƒ±rakƒ±n)</label>
            <input type="text" id="setting-avatar" placeholder="Yeni Avatar URL'si">

            <button id="save-profile-btn" onclick="saveProfileChanges()">Kaydet</button>
            <button id="close-settings-btn" onclick="closeSettings()">Kapat</button>
        </div>
    </div>

    <script>
        const io = require('socket.io-client');
        let socket;

        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const errorDisplay = document.getElementById('login-error');
        
        const messages = document.getElementById('messages');
        const input = document.getElementById('input-message');
        const userList = document.getElementById('user-list');
        const joinBtn = document.getElementById('voice-btn');
        const leaveBtn = document.getElementById('leave-btn');
        const muteBtn = document.getElementById('mute-btn');
        const deafenBtn = document.getElementById('deafen-btn');
        const authTitle = document.getElementById('auth-title');
        const authMainBtn = document.getElementById('auth-main-btn');
        const toggleAuthBtn = document.getElementById('toggle-auth-btn');
        const nicknameInput = document.getElementById('nickname-input');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');

        const profileBar = document.getElementById('profile-bar');
        const myAvatar = document.getElementById('my-avatar');
        const myNickname = document.getElementById('my-nickname');

        const settingsModal = document.getElementById('settings-modal');
        const settingNicknameInput = document.getElementById('setting-nickname');
        const settingAvatarInput = document.getElementById('setting-avatar');
        const profileErrorDisplay = document.getElementById('profile-error-message');

        let currentChatChannel = 'ana-sohbet-kanali';
        let currentVoiceChannel = null;
        let localStream;
        const peerConnections = {};

        let isMuted = false;
        let isDeafened = false;
        let authMode = 'login';
        
        let audioContext;
        let analyser;
        let micSource;
        let isSpeaking = false;
        const SPEAK_THRESHOLD = 50; 
        
        // --- AUTH MANTIƒûI ---
        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            
            if (authMode === 'register') {
                authTitle.textContent = 'Hesap Olu≈ütur';
                authMainBtn.textContent = 'Kayƒ±t Ol';
                toggleAuthBtn.textContent = 'Zaten hesabƒ±n var mƒ±? Giri≈ü Yap';
                nicknameInput.style.display = 'block';
            } else {
                authTitle.textContent = 'Giri≈ü Yap';
                authMainBtn.textContent = 'Giri≈ü Yap';
                toggleAuthBtn.textContent = 'Hesabƒ±n yok mu? Kayƒ±t Ol';
                nicknameInput.style.display = 'none';
            }
            errorDisplay.textContent = '';
        }

        function authenticate() {
            const serverUrl = document.getElementById('server-url-input').value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            const nickname = nicknameInput.value.trim();

            if (!email || !password || (authMode === 'register' && !nickname)) {
                errorDisplay.textContent = 'T√ºm alanlarƒ± doldurmalƒ±sƒ±n.';
                return;
            }
            
            errorDisplay.textContent = 'Baƒülanƒ±yor...';
            if (socket && socket.connected) { socket.disconnect(); }
            socket = io(serverUrl);

            socket.on('connect', () => {
                const authData = { email, password };
                if (authMode === 'register') { authData.nickname = nickname; }

                if (authMode === 'register') {
                    socket.emit('register', authData);
                } else {
                    socket.emit('login', authData);
                }
            });

            socket.on('auth error', (message) => {
                errorDisplay.textContent = `Hata: ${message}`;
                if (socket) socket.disconnect();
            });

            socket.on('auth success', (data) => {
                if (data.type === 'register') {
                    errorDisplay.textContent = 'Kayƒ±t ba≈üarƒ±lƒ±! ≈ûimdi giri≈ü yapabilirsin.';
                    toggleAuthMode();
                }
            });

            socket.on('login success', (data) => {
                loginScreen.style.display = 'none';
                appScreen.style.display = 'flex';
                input.disabled = false;
                joinBtn.disabled = false;
                
                myAvatar.src = data.avatarUrl; 
                myNickname.textContent = data.nickname;

                messages.innerHTML = `<p class="system-msg">Ho≈ü geldin ${data.nickname}, ana kanala katƒ±ldƒ±n.</p>`;
            });

            socket.on('connect_error', (error) => {
                errorDisplay.textContent = `Baƒülantƒ± Hatasƒ±: Sunucuya eri≈üilemiyor.`;
                if (socket) socket.disconnect();
            });
            
            // --- CHAT & KULLANICI Lƒ∞STESƒ∞ MANTIƒûI ---
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    const messageText = input.value;
                    if (messageText && socket && socket.connected) {
                        socket.emit('chat message', { message: messageText, channelId: currentChatChannel });
                        input.value = '';
                    }
                }
            };

            socket.on('chat message', (data) => {
                if (data.channel === currentChatChannel) {
                    const item = document.createElement('p');
                    item.className = 'user-msg';
                    item.innerHTML = `<span class="nickname">${data.nickname}:</span> ${data.message}`; 
                    messages.appendChild(item);
                    messages.scrollTop = messages.scrollHeight;
                }
            });

            // Kullanƒ±cƒ± Listesini G√ºncelleme
            socket.on('user list', (onlineUsers) => {
                userList.innerHTML = '';
                document.querySelectorAll('.voice-user-list').forEach(list => list.innerHTML = '');
                
                onlineUsers.forEach(user => {
                    const status = user.status || {};
                    
                    // 1. Sesli Kanala Baƒülƒ± Kullanƒ±cƒ±lar (SOL KARTLAR)
                    if (status.channel) {
                        const channelId = status.channel.split('-').pop();
                        const listContainer = document.querySelector(`.voice-user-list[data-channel-id="${channelId}"]`);

                        if (listContainer) {
                            const userCard = document.createElement('div');
                            userCard.className = 'voice-user-container';
                            if (status.speaking && !status.muted) userCard.classList.add('speaking-user');
                            
                            let statusIcons = '';
                            if (status.muted) statusIcons += '<span class="muted-icon">üîá</span>';
                            if (status.deafened) statusIcons += '<span class="deafened-icon">üîï</span>';

                            userCard.innerHTML = `
                                <img class="voice-user-avatar" src="${user.avatarUrl}" alt="${user.nickname}">
                                <div class="voice-user-name">${user.nickname}</div>
                                <div class="voice-user-icons">${statusIcons}</div>
                            `;
                            listContainer.appendChild(userCard);
                        }
                    }

                    // 2. T√ºm √áevrimi√ßi Kullanƒ±cƒ±lar (SAƒû Lƒ∞STE)
                    const li = document.createElement('li');
                    li.className = 'user-list-item';
                    li.innerHTML = `<span>${user.nickname}</span>`;
                    userList.appendChild(li);
                });
            });

            // --- WebRTC Sinyalle≈üme Olaylarƒ± ---
            socket.on('user joined', (newUserId) => { if (newUserId !== socket.id) { createPeerConnection(newUserId, true); } });
            socket.on('ready to talk', (otherUsers) => { otherUsers.forEach(userId => { createPeerConnection(userId, true); }); });
            socket.on('user left', (userId) => { if (peerConnections[userId]) { peerConnections[userId].close(); delete peerConnections[userId]; } });
            socket.on('offer', (sendingUserId, offer) => { 
                createPeerConnection(sendingUserId, false); 
                const pc = peerConnections[sendingUserId];
                pc.setRemoteDescription(new RTCSessionDescription(offer))
                    .then(() => pc.createAnswer())
                    .then(answer => pc.setLocalDescription(answer))
                    .then(() => { socket.emit('answer', sendingUserId, pc.localDescription); });
            });
            socket.on('answer', (sendingUserId, answer) => { peerConnections[sendingUserId].setRemoteDescription(new RTCSessionDescription(answer)); });
            socket.on('candidate', (sendingUserId, candidate) => { if (peerConnections[userId]) peerConnections[userId].addIceCandidate(new RTCIceCandidate(candidate)); });
        }
        
        // --- PROFƒ∞L AYARLARI MANTIƒûI ---
        function openSettings() {
            settingsModal.style.display = 'flex';
            settingNicknameInput.value = myNickname.textContent.split(' ')[0];
            settingAvatarInput.value = myAvatar.src;
            profileErrorDisplay.textContent = '';
        }

        function closeSettings() {
            settingsModal.style.display = 'none';
        }

        function saveProfileChanges() {
            const newNickname = settingNicknameInput.value.trim();
            const newAvatar = settingAvatarInput.value.trim();

            if (!newNickname) {
                profileErrorDisplay.textContent = 'Kullanƒ±cƒ± adƒ± bo≈ü bƒ±rakƒ±lamaz.';
                return;
            }
            
            socket.emit('update profile', { newNickname, newAvatarUrl: newAvatar });
        }
        
        // --- Dƒ∞ƒûER KANAL VE SES FONKSƒ∞YONLARI ---
        function switchChatChannel(newChannelId) {
            currentChatChannel = newChannelId;
            messages.innerHTML = `<p class="system-msg">#${newChannelId} kanalƒ±na ge√ßildi.</p>`;
        }

        function joinChannel(channelId, channelType) {
            if (channelType === 'voice') {
                if (!socket || !socket.connected) return alert('√ñnce giri≈ü yapƒ±n.');
                if (currentVoiceChannel === channelId) return;
                
                if (currentVoiceChannel) { leaveVoiceChannel(currentVoiceChannel); }

                currentVoiceChannel = channelId;
                joinVoiceChannel(channelId);
            }
            else if (channelType === 'chat') {
                switchChatChannel(channelId);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.channel-item').forEach(item => {
                item.onclick = (e) => {
                    const id = e.target.getAttribute('data-id');
                    const type = e.target.getAttribute('data-type');
                    
                    document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active-channel'));
                    e.target.classList.add('active-channel');
                    
                    joinChannel(id, type);
                };
            });
            switchChatChannel('ana-sohbet-kanali');
        });
        
        function toggleMute() { 
            if (!localStream) return;
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => { track.enabled = !isMuted; });
            muteBtn.textContent = isMuted ? 'üîá Muted' : 'üé§ Mute';
            muteBtn.classList.toggle('active-status');
            if (isMuted && isSpeaking) { socket.emit('toggle speaking', false); } else if (!isMuted && isSpeaking) { socket.emit('toggle speaking', true); }
            socket.emit('toggle status', { status: 'mute', value: isMuted });
        }
        function toggleDeafen() { 
            isDeafened = !isDeafened;
            if (isDeafened && !isMuted) { toggleMute(); }
            document.querySelectorAll('audio').forEach(audioElement => { audioElement.muted = isDeafened; });
            deafenBtn.textContent = isDeafened ? 'üîï Deafened' : 'üéß Deafen';
            deafenBtn.classList.toggle('active-status');
            socket.emit('toggle status', { status: 'deafen', value: isDeafened });
        }

        function leaveCurrentVoiceChannel() {
            if (currentVoiceChannel) { leaveVoiceChannel(currentVoiceChannel); }
        }

        function leaveVoiceChannel(channelId) { 
            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
            if (audioContext) { audioContext.close(); audioContext = null; } 
            Object.values(peerConnections).forEach(pc => pc.close());
            socket.emit('leave voice channel', channelId);
            currentVoiceChannel = null;
            
            joinBtn.style.display = 'block';
            leaveBtn.style.display = 'none';
            joinBtn.disabled = false;
            muteBtn.disabled = true; deafenBtn.disabled = true; 
            
            isMuted = false; isDeafened = false;
            muteBtn.textContent = 'üé§ Mute'; muteBtn.classList.remove('active-status');
            deafenBtn.textContent = 'üéß Deafen'; deafenBtn.classList.remove('active-status');
        }

        function startVolumeDetection() {
            if (!localStream) return;
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            micSource = audioContext.createMediaStreamSource(localStream);
            micSource.connect(analyser);
            analyser.fftSize = 256; 
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            const checkVolume = () => {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0; for (let i = 0; i < bufferLength; i++) { sum += dataArray[i]; }
                const currentVolume = sum / bufferLength;

                const wasSpeaking = isSpeaking;
                isSpeaking = currentVolume > SPEAK_THRESHOLD && !isMuted;
                
                if (isSpeaking !== wasSpeaking) { socket.emit('toggle speaking', isSpeaking); }

                if (audioContext) requestAnimationFrame(checkVolume);
            };
            checkVolume();
        }

        function joinVoiceChannel(channelId) {
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    localStream = stream;
                    
                    joinBtn.style.display = 'none';
                    leaveBtn.style.display = 'block';
                    muteBtn.disabled = false; deafenBtn.disabled = false; 

                    socket.emit('join voice channel', channelId); 
                    startVolumeDetection();
                })
                .catch(err => {
                    alert('Mikrofon izni gerekiyor!');
                    leaveVoiceChannel(channelId);
                });
        }
        
        function createPeerConnection(userId, isOfferer) {
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peerConnections[userId] = pc;
            localStream.getTracks().forEach(track => { pc.addTrack(track, localStream); });
            
            pc.ontrack = (event) => {
                const remoteAudio = document.createElement('audio');
                remoteAudio.autoplay = true;
                document.body.appendChild(remoteAudio); 
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) { socket.emit('candidate', userId, event.candidate); }
            };
            
            if (isOfferer) {
                pc.onnegotiationneeded = () => {
                    pc.createOffer()
                        .then(offer => pc.setLocalDescription(offer))
                        .then(() => { socket.emit('offer', userId, pc.localDescription); });
                };
            }
        }
    </script>
</body>
</html>
